---
# Status workflow - check status of all services in order: foo -> bar -> elephant
# This playbook is called by orchestrate.yml for status operations

- name: "Initialize workflow tracking"
  hosts: localhost
  gather_facts: true
  connection: local
  tasks:
    - name: "Record workflow start metadata"
      ansible.builtin.set_fact:
        workflow_metadata:
          workflow_type: "status"
          workflow_start_time: "{{ ansible_date_time.iso8601 }}"
          workflow_user: "{{ lookup('env', 'USER') | default(ansible_user_id | default('unknown')) }}"
          ansible_control_node: "{{ ansible_hostname }}"
          workflow_status: "running"
        workflow_tasks: []
      delegate_to: localhost
      delegate_facts: true
      run_once: true  # noqa: run-once

- name: "Foo service - Status"
  hosts: foo_servers
  gather_facts: false
  any_errors_fatal: false
  vars_files:
    - ../vars/foo.yml
  vars:
    cal_service_action: "status"
  tasks:
    - name: "Record task start time for foo service"
      ansible.builtin.set_fact:
        task_start_time: "{{ lookup('pipe', 'date -u +\"%Y-%m-%dT%H:%M:%SZ\"') }}"
      delegate_to: localhost
      delegate_facts: true
      run_once: true  # noqa: run-once

    - name: "Execute foo service status check"
      block:
        - name: "Include cal_role for foo"
          ansible.builtin.include_role:
            name: cal

        - name: "Record successful task completion for foo service"
          ansible.builtin.set_fact:
            workflow_tasks: "{{ hostvars['localhost']['workflow_tasks'] | default([]) + [task_record] }}"
          vars:
            task_record:
              service: "foo"
              action: "status"
              start_time: "{{ hostvars['localhost']['task_start_time'] }}"
              end_time: "{{ lookup('pipe', 'date -u +\"%Y-%m-%dT%H:%M:%SZ\"') }}"
              status: "success"
          delegate_to: localhost
          delegate_facts: true
          run_once: true  # noqa: run-once

      rescue:
        - name: "Record failed task for foo service"
          ansible.builtin.set_fact:
            workflow_tasks: "{{ hostvars['localhost']['workflow_tasks'] | default([]) + [task_record] }}"
            workflow_metadata: "{{ hostvars['localhost']['workflow_metadata'] | combine({'workflow_status': 'failed', 'failure_details': failure_info}) }}"
          vars:
            task_record:
              service: "foo"
              action: "status"
              start_time: "{{ hostvars['localhost']['task_start_time'] }}"
              end_time: "{{ lookup('pipe', 'date -u +\"%Y-%m-%dT%H:%M:%SZ\"') }}"
              status: "failed"
              error: "{{ ansible_failed_result.msg | default('Unknown error') }}"
            failure_info:
              failed_task: "foo service status"
              failed_service: "foo"
              failure_time: "{{ lookup('pipe', 'date -u +\"%Y-%m-%dT%H:%M:%SZ\"') }}"
              error_message: "{{ ansible_failed_result.msg | default('Unknown error') }}"
              error_details: "{{ ansible_failed_result | to_nice_json }}"
          delegate_to: localhost
          delegate_facts: true
          run_once: true  # noqa: run-once

- name: "Bar service - Status"
  hosts: bar_servers
  gather_facts: false
  any_errors_fatal: false
  vars_files:
    - ../vars/bar.yml
  vars:
    cal_service_action: "status"
  tasks:
    - name: "Skip if previous task failed"
      ansible.builtin.meta: end_play
      when: hostvars['localhost']['workflow_metadata']['workflow_status'] == 'failed'

    - name: "Record task start time for bar service"
      ansible.builtin.set_fact:
        task_start_time: "{{ lookup('pipe', 'date -u +\"%Y-%m-%dT%H:%M:%SZ\"') }}"
      delegate_to: localhost
      delegate_facts: true
      run_once: true  # noqa: run-once

    - name: "Execute bar service status check"
      block:
        - name: "Include cal_role for bar"
          ansible.builtin.include_role:
            name: cal

        - name: "Record successful task completion for bar service"
          ansible.builtin.set_fact:
            workflow_tasks: "{{ hostvars['localhost']['workflow_tasks'] | default([]) + [task_record] }}"
          vars:
            task_record:
              service: "bar"
              action: "status"
              start_time: "{{ hostvars['localhost']['task_start_time'] }}"
              end_time: "{{ lookup('pipe', 'date -u +\"%Y-%m-%dT%H:%M:%SZ\"') }}"
              status: "success"
          delegate_to: localhost
          delegate_facts: true
          run_once: true  # noqa: run-once

      rescue:
        - name: "Record failed task for bar service"
          ansible.builtin.set_fact:
            workflow_tasks: "{{ hostvars['localhost']['workflow_tasks'] | default([]) + [task_record] }}"
            workflow_metadata: "{{ hostvars['localhost']['workflow_metadata'] | combine({'workflow_status': 'failed', 'failure_details': failure_info}) }}"
          vars:
            task_record:
              service: "bar"
              action: "status"
              start_time: "{{ hostvars['localhost']['task_start_time'] }}"
              end_time: "{{ lookup('pipe', 'date -u +\"%Y-%m-%dT%H:%M:%SZ\"') }}"
              status: "failed"
              error: "{{ ansible_failed_result.msg | default('Unknown error') }}"
            failure_info:
              failed_task: "bar service status"
              failed_service: "bar"
              failure_time: "{{ lookup('pipe', 'date -u +\"%Y-%m-%dT%H:%M:%SZ\"') }}"
              error_message: "{{ ansible_failed_result.msg | default('Unknown error') }}"
              error_details: "{{ ansible_failed_result | to_nice_json }}"
          delegate_to: localhost
          delegate_facts: true
          run_once: true  # noqa: run-once

- name: "Elephant service - Status"
  hosts: elephant_servers
  gather_facts: false
  any_errors_fatal: false
  vars_files:
    - ../vars/elephant.yml
  vars:
    cal_service_action: "status"
  tasks:
    - name: "Skip if previous task failed"
      ansible.builtin.meta: end_play
      when: hostvars['localhost']['workflow_metadata']['workflow_status'] == 'failed'

    - name: "Record task start time for elephant service"
      ansible.builtin.set_fact:
        task_start_time: "{{ lookup('pipe', 'date -u +\"%Y-%m-%dT%H:%M:%SZ\"') }}"
      delegate_to: localhost
      delegate_facts: true
      run_once: true  # noqa: run-once

    - name: "Execute elephant service status check"
      block:
        - name: "Include cal_role for elephant"
          ansible.builtin.include_role:
            name: cal

        - name: "Record successful task completion for elephant service"
          ansible.builtin.set_fact:
            workflow_tasks: "{{ hostvars['localhost']['workflow_tasks'] | default([]) + [task_record] }}"
          vars:
            task_record:
              service: "elephant"
              action: "status"
              start_time: "{{ hostvars['localhost']['task_start_time'] }}"
              end_time: "{{ lookup('pipe', 'date -u +\"%Y-%m-%dT%H:%M:%SZ\"') }}"
              status: "success"
          delegate_to: localhost
          delegate_facts: true
          run_once: true  # noqa: run-once

      rescue:
        - name: "Record failed task for elephant service"
          ansible.builtin.set_fact:
            workflow_tasks: "{{ hostvars['localhost']['workflow_tasks'] | default([]) + [task_record] }}"
            workflow_metadata: "{{ hostvars['localhost']['workflow_metadata'] | combine({'workflow_status': 'failed', 'failure_details': failure_info}) }}"
          vars:
            task_record:
              service: "elephant"
              action: "status"
              start_time: "{{ hostvars['localhost']['task_start_time'] }}"
              end_time: "{{ lookup('pipe', 'date -u +\"%Y-%m-%dT%H:%M:%SZ\"') }}"
              status: "failed"
              error: "{{ ansible_failed_result.msg | default('Unknown error') }}"
            failure_info:
              failed_task: "elephant service status"
              failed_service: "elephant"
              failure_time: "{{ lookup('pipe', 'date -u +\"%Y-%m-%dT%H:%M:%SZ\"') }}"
              error_message: "{{ ansible_failed_result.msg | default('Unknown error') }}"
              error_details: "{{ ansible_failed_result | to_nice_json }}"
          delegate_to: localhost
          delegate_facts: true
          run_once: true  # noqa: run-once

- name: "Send workflow completion report"
  hosts: localhost
  gather_facts: false
  connection: local
  tasks:
    - name: "Mark workflow as successful if not failed"
      ansible.builtin.set_fact:
        workflow_metadata: "{{ workflow_metadata | combine(update) }}"
      vars:
        update:
          workflow_status: "{{ workflow_metadata.workflow_status if workflow_metadata.workflow_status == 'failed' else 'success' }}"
          workflow_end_time: "{{ lookup('pipe', 'date -u +\"%Y-%m-%dT%H:%M:%SZ\"') }}"

    - name: "Include workflow reporting task"
      ansible.builtin.include_role:
        name: cal
        tasks_from: send_workflow_report

    - name: "Fail playbook if workflow failed"
      ansible.builtin.fail:
        msg: "Status workflow failed - see email report for details"
      when: workflow_metadata.workflow_status == 'failed'
