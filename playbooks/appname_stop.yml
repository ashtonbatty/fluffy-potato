---
# Stop workflow - Refactored with reusable task includes
# Services execute in reverse order: elephant -> bar -> [file_monitoring] -> foo

- name: "Initialize workflow tracking"
  hosts: localhost
  gather_facts: true
  connection: local
  tasks:
    - name: "Record workflow start metadata"
      ansible.builtin.set_fact:
        workflow_metadata:
          workflow_type: "stop"
          workflow_start_time: "{{ ansible_date_time.iso8601 }}"
          workflow_user: "{{ lookup('env', 'USER') | default(ansible_user_id | default('unknown')) }}"
          ansible_control_node: "{{ ansible_hostname }}"
          workflow_status: "running"
        workflow_tasks: []
      delegate_facts: true

- name: "Elephant service - Stop"
  hosts: elephant_servers
  gather_facts: false
  any_errors_fatal: false
  vars_files:
    - ../vars/elephant.yml
  vars:
    appname_service_action: "stop"
    service_item:
      name: elephant
  tasks:
    - name: "Execute service operation with workflow tracking"
      ansible.builtin.include_tasks:
        file: ../roles/appname/tasks/execute_service_with_tracking.yml
      vars:
        service_action: "stop"

- name: "Bar service - Stop"
  hosts: bar_servers
  gather_facts: false
  any_errors_fatal: false
  vars_files:
    - ../vars/bar.yml
  vars:
    appname_service_action: "stop"
    service_item:
      name: bar
  tasks:
    - name: "Skip if previous task failed"
      ansible.builtin.meta: end_play
      when: hostvars['localhost']['workflow_metadata']['workflow_status'] == 'failed'

    - name: "Execute service operation with workflow tracking"
      ansible.builtin.include_tasks:
        file: ../roles/appname/tasks/execute_service_with_tracking.yml
      vars:
        service_action: "stop"

- name: "File monitoring - Wait for file deletion"
  hosts: all_services
  gather_facts: false
  tasks:
    - name: "Skip if previous task failed"
      ansible.builtin.meta: end_play
      when: hostvars['localhost']['workflow_metadata']['workflow_status'] == 'failed'

    - name: "Record file monitoring start time"
      ansible.builtin.set_fact:
        task_start_time: "{{ lookup('pipe', 'date -u +\"%Y-%m-%dT%H:%M:%SZ\"') }}"
      delegate_facts: true
      run_once: true  # noqa: run-once

    - name: "Execute file monitoring task"
      ansible.builtin.include_tasks:
        file: ../roles/appname/tasks/wait_for_files_deleted.yml

    - name: "Record file monitoring completion"
      ansible.builtin.set_fact:
        workflow_tasks: "{{ hostvars['localhost']['workflow_tasks'] | default([]) + [task_record] }}"
      vars:
        task_record:
          service: "file_monitoring"
          action: "wait_for_deletion"
          start_time: "{{ hostvars['localhost']['task_start_time'] }}"
          end_time: "{{ lookup('pipe', 'date -u +\"%Y-%m-%dT%H:%M:%SZ\"') }}"
          status: "success"
      delegate_facts: true
      run_once: true  # noqa: run-once

- name: "Foo service - Stop"
  hosts: foo_servers
  gather_facts: false
  any_errors_fatal: false
  vars_files:
    - ../vars/foo.yml
  vars:
    appname_service_action: "stop"
    service_item:
      name: foo
  tasks:
    - name: "Skip if previous task failed"
      ansible.builtin.meta: end_play
      when: hostvars['localhost']['workflow_metadata']['workflow_status'] == 'failed'

    - name: "Execute service operation with workflow tracking"
      ansible.builtin.include_tasks:
        file: ../roles/appname/tasks/execute_service_with_tracking.yml
      vars:
        service_action: "stop"

- name: "Complete workflow and send report"
  hosts: all_services
  gather_facts: false
  tasks:
    - name: "Mark workflow as complete"
      ansible.builtin.set_fact:
        workflow_metadata: >-
          {{ hostvars['localhost']['workflow_metadata'] | combine({
              'workflow_end_time': lookup('pipe', 'date -u +"%Y-%m-%dT%H:%M:%SZ"'),
              'workflow_status': workflow_final_status
            })
          }}
      vars:
        workflow_final_status: >-
          {{
            hostvars['localhost']['workflow_metadata']['workflow_status']
            if hostvars['localhost']['workflow_metadata']['workflow_status'] == 'failed'
            else 'success'
          }}
      delegate_facts: true
      run_once: true  # noqa: run-once

    - name: "Send comprehensive workflow report"
      ansible.builtin.include_tasks:
        file: ../roles/appname/tasks/send_workflow_report.yml
      run_once: true  # noqa: run-once
