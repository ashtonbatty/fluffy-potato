---
# Status workflow - Refactored with reusable task includes
# Services check in forward order: foo -> bar -> elephant

- name: "Initialize workflow tracking"
  hosts: localhost
  gather_facts: true
  connection: local
  tasks:
    - name: "Record workflow start metadata"
      ansible.builtin.set_fact:
        workflow_metadata:
          workflow_type: "status"
          workflow_start_time: "{{ ansible_date_time.iso8601 }}"
          workflow_user: "{{ lookup('env', 'USER') | default(ansible_user_id | default('unknown')) }}"
          ansible_control_node: "{{ ansible_hostname }}"
          workflow_status: "running"
        workflow_tasks: []
      delegate_facts: true

- name: "Foo service - Status"
  hosts: foo_servers
  gather_facts: false
  any_errors_fatal: false
  vars_files:
    - ../vars/foo.yml
  vars:
    appname_service_action: "status"
    service_item:
      name: foo
  tasks:
    - name: "Execute service operation with workflow tracking"
      ansible.builtin.include_tasks:
        file: ../roles/appname/tasks/execute_service_with_tracking.yml
      vars:
        service_action: "status"

- name: "Bar service - Status"
  hosts: bar_servers
  gather_facts: false
  any_errors_fatal: false
  vars_files:
    - ../vars/bar.yml
  vars:
    appname_service_action: "status"
    service_item:
      name: bar
  tasks:
    - name: "Skip if previous task failed"
      ansible.builtin.meta: end_play
      when: hostvars['localhost']['workflow_metadata']['workflow_status'] == 'failed'

    - name: "Execute service operation with workflow tracking"
      ansible.builtin.include_tasks:
        file: ../roles/appname/tasks/execute_service_with_tracking.yml
      vars:
        service_action: "status"

- name: "Elephant service - Status"
  hosts: elephant_servers
  gather_facts: false
  any_errors_fatal: false
  vars_files:
    - ../vars/elephant.yml
  vars:
    appname_service_action: "status"
    service_item:
      name: elephant
  tasks:
    - name: "Skip if previous task failed"
      ansible.builtin.meta: end_play
      when: hostvars['localhost']['workflow_metadata']['workflow_status'] == 'failed'

    - name: "Execute service operation with workflow tracking"
      ansible.builtin.include_tasks:
        file: ../roles/appname/tasks/execute_service_with_tracking.yml
      vars:
        service_action: "status"

- name: "Complete workflow and send report"
  hosts: all_services
  gather_facts: false
  tasks:
    - name: "Mark workflow as complete"
      ansible.builtin.set_fact:
        workflow_metadata: >-
          {{ hostvars['localhost']['workflow_metadata'] | combine({
              'workflow_end_time': lookup('pipe', 'date -u +"%Y-%m-%dT%H:%M:%SZ"'),
              'workflow_status': workflow_final_status
            })
          }}
      vars:
        workflow_final_status: >-
          {{
            hostvars['localhost']['workflow_metadata']['workflow_status']
            if hostvars['localhost']['workflow_metadata']['workflow_status'] == 'failed'
            else 'success'
          }}
      delegate_facts: true
      run_once: true  # noqa: run-once

    - name: "Send comprehensive workflow report"
      ansible.builtin.include_tasks:
        file: ../roles/appname/tasks/send_workflow_report.yml
      run_once: true  # noqa: run-once
