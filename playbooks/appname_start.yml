---
# Start workflow - Refactored with reusable task includes
# Services execute in forward order: foo -> bar -> elephant

- name: "Initialize workflow tracking"
  hosts: localhost
  gather_facts: true
  connection: local
  tasks:
    - name: "Record workflow start metadata"
      ansible.builtin.set_fact:
        workflow_metadata:
          workflow_type: "start"
          workflow_start_time: "{{ ansible_date_time.iso8601 }}"
          workflow_user: "{{ lookup('env', 'USER') | default(ansible_user_id | default('unknown')) }}"
          ansible_control_node: "{{ ansible_hostname }}"
          workflow_status: "running"
        workflow_tasks: []
      delegate_facts: true

- name: "Foo service - Start"
  hosts: foo_servers
  gather_facts: false
  any_errors_fatal: false
  vars:
    appname_service_action: "start"
    service_item:
      name: foo
  tasks:
    - name: "Execute service operation with workflow tracking"
      ansible.builtin.include_tasks:
        file: ../roles/appname/tasks/execute_service_with_tracking.yml
      vars:
        service_action: "start"

- name: "Bar service - Start"
  hosts: bar_servers
  gather_facts: false
  any_errors_fatal: false
  vars:
    appname_service_action: "start"
    service_item:
      name: bar
  tasks:
    - name: "Skip if previous task failed"
      ansible.builtin.meta: end_play
      when: hostvars['localhost']['workflow_metadata']['workflow_status'] == 'failed'

    - name: "Execute service operation with workflow tracking"
      ansible.builtin.include_tasks:
        file: ../roles/appname/tasks/execute_service_with_tracking.yml
      vars:
        service_action: "start"

- name: "Elephant service - Start"
  hosts: elephant_servers
  gather_facts: false
  any_errors_fatal: false
  vars:
    appname_service_action: "start"
    service_item:
      name: elephant
  tasks:
    - name: "Skip if previous task failed"
      ansible.builtin.meta: end_play
      when: hostvars['localhost']['workflow_metadata']['workflow_status'] == 'failed'

    - name: "Execute service operation with workflow tracking"
      ansible.builtin.include_tasks:
        file: ../roles/appname/tasks/execute_service_with_tracking.yml
      vars:
        service_action: "start"

- name: "Finalize workflow"
  ansible.builtin.import_playbook: common/finalize_workflow.yml
