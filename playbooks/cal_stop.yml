---
# Stop workflow - services stop in reverse order: elephant -> bar -> foo
# This playbook is called by orchestrate.yml for stop operations

- name: "Initialize workflow tracking"
  hosts: localhost
  gather_facts: true
  connection: local
  tasks:
    - name: "Record workflow start metadata"
      ansible.builtin.set_fact:
        workflow_metadata:
          workflow_type: "stop"
          workflow_start_time: "{{ ansible_date_time.iso8601 }}"
          workflow_user: "{{ lookup('env', 'USER') | default(ansible_user_id | default('unknown')) }}"
          ansible_control_node: "{{ ansible_hostname }}"
          workflow_status: "running"
        workflow_tasks: []
      delegate_to: localhost
      delegate_facts: true
      run_once: true  # noqa: run-once

- name: "Elephant service - Stop"
  hosts: elephant_servers
  gather_facts: false
  any_errors_fatal: false
  vars_files:
    - ../vars/elephant.yml
  vars:
    cal_role_service_action: "stop"
  tasks:
    - name: "Record task start time for elephant service"
      ansible.builtin.set_fact:
        task_start_time: "{{ lookup('pipe', 'date -u +\"%Y-%m-%dT%H:%M:%SZ\"') }}"
      delegate_to: localhost
      delegate_facts: true
      run_once: true  # noqa: run-once

    - name: "Execute elephant service stop"
      block:
        - name: "Include cal_role for elephant"
          ansible.builtin.include_role:
            name: cal_role

        - name: "Record successful task completion for elephant service"
          ansible.builtin.set_fact:
            workflow_tasks: "{{ hostvars['localhost']['workflow_tasks'] | default([]) + [task_record] }}"
          vars:
            task_record:
              service: "elephant"
              action: "stop"
              start_time: "{{ hostvars['localhost']['task_start_time'] }}"
              end_time: "{{ lookup('pipe', 'date -u +\"%Y-%m-%dT%H:%M:%SZ\"') }}"
              status: "success"
          delegate_to: localhost
          delegate_facts: true
          run_once: true  # noqa: run-once

      rescue:
        - name: "Record failed task for elephant service"
          ansible.builtin.set_fact:
            workflow_tasks: "{{ hostvars['localhost']['workflow_tasks'] | default([]) + [task_record] }}"
            workflow_metadata: "{{ hostvars['localhost']['workflow_metadata'] | combine({'workflow_status': 'failed', 'failure_details': failure_info}) }}"
          vars:
            task_record:
              service: "elephant"
              action: "stop"
              start_time: "{{ hostvars['localhost']['task_start_time'] }}"
              end_time: "{{ lookup('pipe', 'date -u +\"%Y-%m-%dT%H:%M:%SZ\"') }}"
              status: "failed"
              error: "{{ ansible_failed_result.msg | default('Unknown error') }}"
            failure_info:
              failed_task: "elephant service stop"
              failed_service: "elephant"
              failure_time: "{{ lookup('pipe', 'date -u +\"%Y-%m-%dT%H:%M:%SZ\"') }}"
              error_message: "{{ ansible_failed_result.msg | default('Unknown error') }}"
              error_details: "{{ ansible_failed_result | to_nice_json }}"
          delegate_to: localhost
          delegate_facts: true
          run_once: true  # noqa: run-once

- name: "Bar service - Stop"
  hosts: bar_servers
  gather_facts: false
  any_errors_fatal: false
  vars_files:
    - ../vars/bar.yml
  vars:
    cal_role_service_action: "stop"
  tasks:
    - name: "Skip if previous task failed"
      ansible.builtin.meta: end_play
      when: hostvars['localhost']['workflow_metadata']['workflow_status'] == 'failed'

    - name: "Record task start time for bar service"
      ansible.builtin.set_fact:
        task_start_time: "{{ lookup('pipe', 'date -u +\"%Y-%m-%dT%H:%M:%SZ\"') }}"
      delegate_to: localhost
      delegate_facts: true
      run_once: true  # noqa: run-once

    - name: "Execute bar service stop"
      block:
        - name: "Include cal_role for bar"
          ansible.builtin.include_role:
            name: cal_role

        - name: "Record successful task completion for bar service"
          ansible.builtin.set_fact:
            workflow_tasks: "{{ hostvars['localhost']['workflow_tasks'] | default([]) + [task_record] }}"
          vars:
            task_record:
              service: "bar"
              action: "stop"
              start_time: "{{ hostvars['localhost']['task_start_time'] }}"
              end_time: "{{ lookup('pipe', 'date -u +\"%Y-%m-%dT%H:%M:%SZ\"') }}"
              status: "success"
          delegate_to: localhost
          delegate_facts: true
          run_once: true  # noqa: run-once

      rescue:
        - name: "Record failed task for bar service"
          ansible.builtin.set_fact:
            workflow_tasks: "{{ hostvars['localhost']['workflow_tasks'] | default([]) + [task_record] }}"
            workflow_metadata: "{{ hostvars['localhost']['workflow_metadata'] | combine({'workflow_status': 'failed', 'failure_details': failure_info}) }}"
          vars:
            task_record:
              service: "bar"
              action: "stop"
              start_time: "{{ hostvars['localhost']['task_start_time'] }}"
              end_time: "{{ lookup('pipe', 'date -u +\"%Y-%m-%dT%H:%M:%SZ\"') }}"
              status: "failed"
              error: "{{ ansible_failed_result.msg | default('Unknown error') }}"
            failure_info:
              failed_task: "bar service stop"
              failed_service: "bar"
              failure_time: "{{ lookup('pipe', 'date -u +\"%Y-%m-%dT%H:%M:%SZ\"') }}"
              error_message: "{{ ansible_failed_result.msg | default('Unknown error') }}"
              error_details: "{{ ansible_failed_result | to_nice_json }}"
          delegate_to: localhost
          delegate_facts: true
          run_once: true  # noqa: run-once

- name: "Wait for files to be deleted (post-bar, pre-foo)"
  hosts: all_services
  gather_facts: false
  any_errors_fatal: false
  tasks:
    - name: "Skip if previous task failed"
      ansible.builtin.meta: end_play
      when: hostvars['localhost']['workflow_metadata']['workflow_status'] == 'failed'

    - name: "Record task start time for file monitoring"
      ansible.builtin.set_fact:
        task_start_time: "{{ lookup('pipe', 'date -u +\"%Y-%m-%dT%H:%M:%SZ\"') }}"
      delegate_to: localhost
      delegate_facts: true
      run_once: true  # noqa: run-once

    - name: "Execute file monitoring"
      block:
        - name: "Include file monitoring task"
          ansible.builtin.include_role:
            name: cal_role
            tasks_from: wait_for_files_deleted

        - name: "Record successful task completion for file monitoring"
          ansible.builtin.set_fact:
            workflow_tasks: "{{ hostvars['localhost']['workflow_tasks'] | default([]) + [task_record] }}"
          vars:
            task_record:
              service: "file_monitoring"
              action: "wait_for_deletion"
              start_time: "{{ hostvars['localhost']['task_start_time'] }}"
              end_time: "{{ lookup('pipe', 'date -u +\"%Y-%m-%dT%H:%M:%SZ\"') }}"
              status: "success"
          delegate_to: localhost
          delegate_facts: true
          run_once: true  # noqa: run-once

      rescue:
        - name: "Record failed task for file monitoring"
          ansible.builtin.set_fact:
            workflow_tasks: "{{ hostvars['localhost']['workflow_tasks'] | default([]) + [task_record] }}"
            workflow_metadata: "{{ hostvars['localhost']['workflow_metadata'] | combine({'workflow_status': 'failed', 'failure_details': failure_info}) }}"
          vars:
            task_record:
              service: "file_monitoring"
              action: "wait_for_deletion"
              start_time: "{{ hostvars['localhost']['task_start_time'] }}"
              end_time: "{{ lookup('pipe', 'date -u +\"%Y-%m-%dT%H:%M:%SZ\"') }}"
              status: "failed"
              error: "{{ ansible_failed_result.msg | default('Unknown error') }}"
            failure_info:
              failed_task: "file monitoring"
              failed_service: "file_monitoring"
              failure_time: "{{ lookup('pipe', 'date -u +\"%Y-%m-%dT%H:%M:%SZ\"') }}"
              error_message: "{{ ansible_failed_result.msg | default('Unknown error') }}"
              error_details: "{{ ansible_failed_result | to_nice_json }}"
          delegate_to: localhost
          delegate_facts: true
          run_once: true  # noqa: run-once

- name: "Foo service - Stop"
  hosts: foo_servers
  gather_facts: false
  any_errors_fatal: false
  vars_files:
    - ../vars/foo.yml
  vars:
    cal_role_service_action: "stop"
  tasks:
    - name: "Skip if previous task failed"
      ansible.builtin.meta: end_play
      when: hostvars['localhost']['workflow_metadata']['workflow_status'] == 'failed'

    - name: "Record task start time for foo service"
      ansible.builtin.set_fact:
        task_start_time: "{{ lookup('pipe', 'date -u +\"%Y-%m-%dT%H:%M:%SZ\"') }}"
      delegate_to: localhost
      delegate_facts: true
      run_once: true  # noqa: run-once

    - name: "Execute foo service stop"
      block:
        - name: "Include cal_role for foo"
          ansible.builtin.include_role:
            name: cal_role

        - name: "Record successful task completion for foo service"
          ansible.builtin.set_fact:
            workflow_tasks: "{{ hostvars['localhost']['workflow_tasks'] | default([]) + [task_record] }}"
          vars:
            task_record:
              service: "foo"
              action: "stop"
              start_time: "{{ hostvars['localhost']['task_start_time'] }}"
              end_time: "{{ lookup('pipe', 'date -u +\"%Y-%m-%dT%H:%M:%SZ\"') }}"
              status: "success"
          delegate_to: localhost
          delegate_facts: true
          run_once: true  # noqa: run-once

      rescue:
        - name: "Record failed task for foo service"
          ansible.builtin.set_fact:
            workflow_tasks: "{{ hostvars['localhost']['workflow_tasks'] | default([]) + [task_record] }}"
            workflow_metadata: "{{ hostvars['localhost']['workflow_metadata'] | combine({'workflow_status': 'failed', 'failure_details': failure_info}) }}"
          vars:
            task_record:
              service: "foo"
              action: "stop"
              start_time: "{{ hostvars['localhost']['task_start_time'] }}"
              end_time: "{{ lookup('pipe', 'date -u +\"%Y-%m-%dT%H:%M:%SZ\"') }}"
              status: "failed"
              error: "{{ ansible_failed_result.msg | default('Unknown error') }}"
            failure_info:
              failed_task: "foo service stop"
              failed_service: "foo"
              failure_time: "{{ lookup('pipe', 'date -u +\"%Y-%m-%dT%H:%M:%SZ\"') }}"
              error_message: "{{ ansible_failed_result.msg | default('Unknown error') }}"
              error_details: "{{ ansible_failed_result | to_nice_json }}"
          delegate_to: localhost
          delegate_facts: true
          run_once: true  # noqa: run-once

- name: "Send workflow completion report"
  hosts: localhost
  gather_facts: false
  connection: local
  tasks:
    - name: "Mark workflow as successful if not failed"
      ansible.builtin.set_fact:
        workflow_metadata: "{{ workflow_metadata | combine(update) }}"
      vars:
        update:
          workflow_status: "{{ workflow_metadata.workflow_status if workflow_metadata.workflow_status == 'failed' else 'success' }}"
          workflow_end_time: "{{ lookup('pipe', 'date -u +\"%Y-%m-%dT%H:%M:%SZ\"') }}"

    - name: "Include workflow reporting task"
      ansible.builtin.include_role:
        name: cal_role
        tasks_from: send_workflow_report

    - name: "Fail playbook if workflow failed"
      ansible.builtin.fail:
        msg: "Stop workflow failed - see email report for details"
      when: workflow_metadata.workflow_status == 'failed'
