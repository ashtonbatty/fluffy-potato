---
# Wait for files to be deleted from a directory and report remaining files via email
- name: "Check if file monitoring is enabled"
  ansible.builtin.debug:
    msg: "Monitoring {{ cal_file_monitor_path }} for file deletion"
  when: cal_file_monitor_enabled | default(false)

- name: "Wait for files to be deleted from {{ cal_file_monitor_path }}"
  when: cal_file_monitor_enabled | default(false)
  block:
    - name: "Monitor directory for file deletion with timeout"
      ansible.builtin.shell: |
        set -o pipefail
        end_time=$(($(date +%s) + {{ cal_file_monitor_timeout }}))
        while [ $(date +%s) -lt $end_time ]; do
          # Build find command with patterns
          pattern_args="{{ cal_file_monitor_patterns | map('regex_replace', '^(.*)$', '-name \"\\1\"') | join(' -o ') }}"
          found_files=$(find "{{ cal_file_monitor_path }}" -maxdepth 1 -type f \( $pattern_args \) 2>/dev/null | wc -l)

          if [ $found_files -eq 0 ]; then
            echo "All files deleted"
            exit 0
          fi

          sleep {{ cal_file_monitor_check_interval }}
        done

        # Timeout reached, files still present
        echo "Timeout: files still present"
        exit 1
      register: cal_monitor_result
      failed_when: false
      changed_when: false
      async: "{{ cal_file_monitor_timeout + 10 }}"
      poll: 1

    - name: "Gather remaining file information if timeout occurred"
      when: cal_monitor_result.rc != 0
      block:
        - name: "Find remaining files matching patterns"
          ansible.builtin.find:
            paths: "{{ cal_file_monitor_path }}"
            patterns: "{{ cal_file_monitor_patterns }}"
            recurse: false
          register: cal_remaining_files

        - name: "Record remaining files event for reporting"
          ansible.builtin.set_fact:
            cal_file_monitor_events: "{{ cal_file_monitor_events | default([]) + [file_event] }}"
          vars:
            file_event:
              hostname: "{{ inventory_hostname }}"
              directory: "{{ cal_file_monitor_path }}"
              timeout: "{{ cal_file_monitor_timeout }}"
              remaining_files: "{{ cal_remaining_files.files }}"
          when: cal_remaining_files.files | length > 0

        - name: "Display file monitoring status"
          ansible.builtin.debug:
            msg: "{{ cal_remaining_files.files | length }} files still present in {{ cal_file_monitor_path }} after timeout"
          when: cal_remaining_files.files | length > 0

        - name: "Fail if configured to fail on timeout"
          ansible.builtin.fail:
            msg: "File deletion timeout: {{ cal_remaining_files.files | length }} files still present in {{ cal_file_monitor_path }}"
          when:
            - cal_remaining_files.files | length > 0
            - cal_file_monitor_fail_on_timeout | default(true)

    - name: "All files successfully deleted"
      ansible.builtin.debug:
        msg: "All monitored files have been deleted from {{ cal_file_monitor_path }}"
      when: cal_monitor_result.rc == 0
