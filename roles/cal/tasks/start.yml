---
# Idempotency pre-check
- name: "Check if service is already running for {{ cal_service_name }}"
  ansible.builtin.command: "{{ cal_service_script }} status"
  register: cal_pre_start_check
  failed_when: false
  changed_when: false
  async: "{{ cal_script_timeout }}"
  poll: 1

- name: "Service already running, skipping start for {{ cal_service_name }}"
  ansible.builtin.debug:
    msg: "{{ cal_service_name }} is already running, skipping"
  when: cal_running_check_string in cal_pre_start_check.stdout

- name: "Start service for {{ cal_service_name }}"
  ansible.builtin.command: "{{ cal_service_script }} start"
  register: cal_start_result
  when: cal_running_check_string not in cal_pre_start_check.stdout
  changed_when: cal_start_result.rc == 0
  async: "{{ cal_script_timeout }}"
  poll: 1
  failed_when: >
    (cal_start_check_string not in cal_start_result.stdout) or
    (cal_start_expected_rc is defined and cal_start_result.rc != cal_start_expected_rc)

- name: "Verify service is running for {{ cal_service_name }}"
  ansible.builtin.command: "{{ cal_service_script }} status"
  register: cal_status_result
  when: cal_running_check_string not in cal_pre_start_check.stdout
  until: cal_running_check_string in cal_status_result.stdout
  retries: "{{ cal_start_retries }}"
  delay: "{{ cal_retry_delay }}"
  async: "{{ cal_script_timeout }}"
  poll: 1
  changed_when: false
  failed_when: >
    (cal_running_check_string not in cal_status_result.stdout) or
    (cal_status_expected_rc is defined and cal_status_result.rc != cal_status_expected_rc)

- name: "Service started successfully for {{ cal_service_name }}"
  ansible.builtin.debug:
    msg: "{{ cal_service_name }} started successfully and is running"
  when: cal_running_check_string not in cal_pre_start_check.stdout
