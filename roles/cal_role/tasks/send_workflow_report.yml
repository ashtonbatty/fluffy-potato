---
# Send comprehensive workflow report for all start/stop runs
# Includes workflow metadata, task timing, force kills, file monitoring, and failures

- name: "Gather force kill events from all hosts"
  ansible.builtin.set_fact:
    cal_role_all_force_kill_events: >-
      {{ ansible_play_hosts_all |
         map('extract', hostvars, 'cal_role_force_kill_events') |
         select('defined') | flatten | list }}
  run_once: true  # noqa: run-once

- name: "Gather file monitoring events from all hosts"
  ansible.builtin.set_fact:
    cal_role_all_file_monitor_events: >-
      {{ ansible_play_hosts_all |
         map('extract', hostvars, 'cal_role_file_monitor_events') |
         select('defined') | flatten | list }}
  run_once: true  # noqa: run-once

- name: "Calculate workflow duration"
  ansible.builtin.set_fact:
    cal_role_workflow_duration: >-
      {{ ((workflow_metadata.workflow_end_time | to_datetime('%Y-%m-%dT%H:%M:%SZ')) -
          (workflow_metadata.workflow_start_time | to_datetime('%Y-%m-%dT%H:%M:%SZ'))).total_seconds() | int }}
  run_once: true  # noqa: run-once

- name: "Determine email subject based on workflow status"
  ansible.builtin.set_fact:
    cal_role_email_subject: >-
      {{ '[SUCCESS]' if workflow_metadata.workflow_status == 'success' else '[FAILURE]' }}
      {{ workflow_metadata.workflow_type | upper }} workflow completed -
      {{ workflow_metadata.ansible_control_node }}
  run_once: true  # noqa: run-once

- name: "Build comprehensive workflow report"
  ansible.builtin.set_fact:
    cal_role_workflow_report: |
      {% if workflow_metadata.workflow_status != 'success' %}
      !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
      !!! WORKFLOW FAILED - SEE FAILURE DETAILS BELOW
      !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

      {% endif %}
      ================================================================================
      WORKFLOW REPORT: {{ workflow_metadata.workflow_type | upper }}
      ================================================================================

      Workflow Status: {{ workflow_metadata.workflow_status | upper }}
      Workflow Type: {{ workflow_metadata.workflow_type }}
      Started: {{ workflow_metadata.workflow_start_time }}
      Completed: {{ workflow_metadata.workflow_end_time }}
      Duration: {{ cal_role_workflow_duration }} seconds ({{ (cal_role_workflow_duration / 60) | round(2) }} minutes)

      Initiated By: {{ workflow_metadata.workflow_user }}
      Ansible Control Node: {{ workflow_metadata.ansible_control_node }}

      {% if workflow_metadata.workflow_status != 'success' and workflow_metadata.failure_details is defined %}
      ================================================================================
      FAILURE DETAILS
      ================================================================================

      Failed Task: {{ workflow_metadata.failure_details.failed_task | default('Unknown') }}
      Failed Service: {{ workflow_metadata.failure_details.failed_service | default('Unknown') }}
      Failure Time: {{ workflow_metadata.failure_details.failure_time | default('Unknown') }}

      Error Message:
      {{ workflow_metadata.failure_details.error_message | default('No error message available') }}

      {% if workflow_metadata.failure_details.error_details is defined %}
      Error Details:
      {{ workflow_metadata.failure_details.error_details }}
      {% endif %}

      {% endif %}
      ================================================================================
      TASK EXECUTION TIMELINE
      ================================================================================

      {% for task in workflow_tasks %}
      Service: {{ task.service }}
      Action: {{ task.action }}
      Start Time: {{ task.start_time }}
      End Time: {{ task.end_time }}
      Status: {{ task.status | upper }}
      Duration: {{ ((task.end_time | to_datetime('%Y-%m-%dT%H:%M:%SZ')) -
                    (task.start_time | to_datetime('%Y-%m-%dT%H:%M:%SZ'))
                   ).total_seconds() | int }} seconds
      {% if task.status != 'success' and task.error is defined %}
      Error: {{ task.error }}
      {% endif %}

      {% endfor %}

      {% if cal_role_all_force_kill_events | default([]) | length > 0 %}
      ================================================================================
      FORCE KILL EVENTS ({{ cal_role_all_force_kill_events | length }})
      ================================================================================

      {% for event in cal_role_all_force_kill_events %}
      Hostname: {{ event.hostname }}
      Service: {{ event.service_name }}
      Timestamp: {{ event.timestamp }}
      Process Identifier: {{ event.process_identifier }}

      Process Details (ps aux):
      {{ event.ps_details }}

      {% endfor %}
      {% endif %}

      {% if cal_role_all_file_monitor_events | default([]) | length > 0 %}
      ================================================================================
      FILE MONITORING EVENTS ({{ cal_role_all_file_monitor_events | length }})
      ================================================================================

      {% for event in cal_role_all_file_monitor_events %}
      Hostname: {{ event.hostname }}
      Directory: {{ event.directory }}
      Timeout: {{ event.timeout }} seconds

      Remaining files ({{ event.remaining_files | length }}):
      {% for file in event.remaining_files %}

      File: {{ file.path }}
        Size: {{ file.size }} bytes ({{ (file.size / 1024 / 1024) | round(2) }} MB)
        Modified: {{ '%Y-%m-%d %H:%M:%S' | strftime(file.mtime) }}
        Owner: {{ file.pw_name }}
        Permissions: {{ file.mode }}
      {% endfor %}

      {% endfor %}
      {% endif %}

      ================================================================================
      SUMMARY
      ================================================================================

      Workflow: {{ workflow_metadata.workflow_type | upper }}
      Status: {{ workflow_metadata.workflow_status | upper }}
      Total Tasks: {{ workflow_tasks | length }}
      Successful Tasks: {{ workflow_tasks | selectattr('status', 'equalto', 'success') | list | length }}
      Failed Tasks: {{ workflow_tasks | rejectattr('status', 'equalto', 'success') | list | length }}
      Force Kills: {{ cal_role_all_force_kill_events | default([]) | length }}
      File Monitoring Issues: {{ cal_role_all_file_monitor_events | default([]) | length }}

      ================================================================================
      END OF REPORT
      ================================================================================
  run_once: true  # noqa: run-once

- name: "Send workflow report email"
  community.general.mail:
    host: "{{ cal_role_email_smtp_host }}"
    port: "{{ cal_role_email_smtp_port }}"
    from: "{{ cal_role_email_from }}"
    to: "{{ cal_role_email_to }}"
    subject: "{{ cal_role_email_subject_prefix }} {{ cal_role_email_subject }}"
    body: "{{ cal_role_workflow_report }}"
    secure: "{{ cal_role_email_secure }}"
  run_once: true  # noqa: run-once
  when: cal_role_email_enabled | default(true)

- name: "Display workflow report"
  ansible.builtin.debug:
    msg: "{{ cal_role_workflow_report }}"
  run_once: true  # noqa: run-once
