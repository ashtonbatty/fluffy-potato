---
# Idempotency pre-check
- name: "Check if {{ service_name }} is already stopped"
  ansible.builtin.shell: "{{ service_script }} status"
  register: pre_stop_check
  failed_when: false
  become: "{{ service_become }}"
  become_user: "{{ service_become_user }}"
  become_flags: "{{ service_become_flags }}"

- name: "Skip stop - {{ service_name }} already stopped"
  ansible.builtin.debug:
    msg: "{{ service_name }} is already stopped, skipping"
  when: stopped_check_string in pre_stop_check.stdout

- name: "Stop {{ service_name }} service with block-rescue pattern"
  when: stopped_check_string not in pre_stop_check.stdout
  block:
    - name: "Stop {{ service_name }} service"
      ansible.builtin.shell: "{{ service_script }} stop"
      register: stop_result
      become: "{{ service_become }}"
      become_user: "{{ service_become_user }}"
      become_flags: "{{ service_become_flags }}"
      failed_when: >
        (stop_check_string not in stop_result.stdout) or
        (stop_check_rc and
          ((stop_expect_zero_rc and stop_result.rc != 0) or
           (not stop_expect_zero_rc and stop_result.rc == 0)))

    - name: "Verify {{ service_name }} has stopped"
      ansible.builtin.shell: "{{ service_script }} status"
      register: status_result
      become: "{{ service_become }}"
      become_user: "{{ service_become_user }}"
      become_flags: "{{ service_become_flags }}"
      until: stopped_check_string in status_result.stdout
      retries: 3
      delay: "{{ (wait_seconds | int / 3) | int | default(3, true) }}"
      failed_when: >
        (stopped_check_string not in status_result.stdout) or
        (status_check_rc and
          ((status_expect_zero_rc and status_result.rc != 0) or
           (not status_expect_zero_rc and status_result.rc == 0)))

    - name: "{{ service_name }} stopped successfully"
      ansible.builtin.debug:
        msg: "{{ service_name }} stopped successfully"

  rescue:
    - name: "{{ service_name }} did not stop gracefully, killing process"
      ansible.builtin.debug:
        msg: "{{ service_name }} failed to stop gracefully, attempting to kill process with identifier: {{ process_identifier }}"

    - name: "Kill {{ service_name }} process by identifier"
      ansible.builtin.shell: |
        pkill -9 -f -- {{ process_identifier | quote }}
      register: kill_result
      become: "{{ service_become }}"
      become_user: "{{ service_become_user }}"
      become_flags: "{{ service_become_flags }}"
      failed_when: kill_result.rc not in [0, 1]

    - name: "Wait {{ post_kill_wait_seconds }} seconds after kill"
      ansible.builtin.pause:
        seconds: "{{ post_kill_wait_seconds }}"

    - name: "Verify {{ service_name }} process is dead"
      ansible.builtin.shell: "{{ service_script }} status"
      register: final_status
      become: "{{ service_become }}"
      become_user: "{{ service_become_user }}"
      become_flags: "{{ service_become_flags }}"
      until: stopped_check_string in final_status.stdout
      retries: 2
      delay: 3
      failed_when: >
        (stopped_check_string not in final_status.stdout) or
        (status_check_rc and
          ((status_expect_zero_rc and final_status.rc != 0) or
           (not status_expect_zero_rc and final_status.rc == 0)))

    - name: "{{ service_name }} process killed successfully"
      ansible.builtin.debug:
        msg: "{{ service_name }} process killed successfully, service is now stopped"
