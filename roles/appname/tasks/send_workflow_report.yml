---
# Send comprehensive workflow report for all start/stop runs
# Includes workflow metadata, task timing, force kills, file monitoring, and failures

- name: "Gather force kill events from all hosts"
  ansible.builtin.set_fact:
    appname_all_force_kill_events: >-
      {{ ansible_play_hosts_all |
         map('extract', hostvars, 'appname_force_kill_events') |
         select('defined') | flatten | list }}
  run_once: true  # noqa: run-once

- name: "Gather file monitoring events from all hosts"
  ansible.builtin.set_fact:
    appname_all_file_monitor_events: >-
      {{ ansible_play_hosts_all |
         map('extract', hostvars, 'appname_file_monitor_events') |
         select('defined') | flatten | list }}
  run_once: true  # noqa: run-once

- name: "Calculate workflow duration"
  ansible.builtin.set_fact:
    appname_workflow_duration: >-
      {{ ((workflow_metadata.workflow_end_time | to_datetime('%Y-%m-%dT%H:%M:%SZ')) -
          (workflow_metadata.workflow_start_time | to_datetime('%Y-%m-%dT%H:%M:%SZ'))).total_seconds() | int }}
  run_once: true  # noqa: run-once

- name: "Determine email subject based on workflow status"
  ansible.builtin.set_fact:
    appname_email_subject: >-
      {{ '[SUCCESS]' if workflow_metadata.workflow_status == 'success' else '[FAILURE]' }}
      {{ workflow_metadata.workflow_type | upper }} workflow completed -
      {{ workflow_metadata.ansible_control_node }}
  run_once: true  # noqa: run-once

- name: "Build comprehensive workflow report from template"
  ansible.builtin.set_fact:
    appname_workflow_report: "{{ lookup('template', 'workflow_report.j2') }}"
  run_once: true  # noqa: run-once

- name: "Send workflow report email"
  community.general.mail:
    host: "{{ appname_email_smtp_host }}"
    port: "{{ appname_email_smtp_port }}"
    from: "{{ appname_email_from }}"
    to: "{{ appname_email_to }}"
    subject: "{{ appname_email_subject_prefix }} {{ appname_email_subject }}"
    body: "{{ appname_workflow_report }}"
    secure: "{{ appname_email_secure }}"
  run_once: true  # noqa: run-once
  when: appname_email_enabled | default(true)

- name: "Display workflow report"
  ansible.builtin.debug:
    msg: "{{ appname_workflow_report }}"
  run_once: true  # noqa: run-once
