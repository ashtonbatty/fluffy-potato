---
- name: "Validate service action is allowed - {{ appname_service_action }}"
  ansible.builtin.assert:
    that:
      - appname_service_action is defined
      - appname_service_action in ['start', 'stop', 'status']
    fail_msg: "appname_service_action must be one of: start, stop, status. Got: {{ appname_service_action | default('undefined') }}"
    success_msg: "Service action {{ appname_service_action }} is valid"

- name: "Validate service script exists and is executable - {{ appname_service_script }}"
  ansible.builtin.stat:
    path: "{{ appname_service_script }}"
  register: appname_script_stat
  become: "{{ appname_service_become }}"
  become_user: "{{ appname_service_become_user }}"
  become_flags: "{{ appname_service_become_flags }}"
  async: "{{ appname_script_timeout }}"
  poll: 1
  failed_when: not appname_script_stat.stat.exists or not appname_script_stat.stat.executable
  when: appname_service_script is defined

- name: "Execute service action - {{ appname_service_action }} (script-based)"
  become: "{{ appname_service_become }}"
  become_user: "{{ appname_service_become_user }}"
  become_flags: "{{ appname_service_become_flags }}"
  when: appname_service_script is defined
  block:
    - name: "Include script-based action tasks - {{ appname_service_action }}"
      ansible.builtin.include_tasks: "{{ appname_service_action }}.yml"

- name: "Execute service action - {{ appname_service_action }} (service module)"
  become: "{{ appname_service_become }}"
  become_user: "{{ appname_service_become_user }}"
  become_flags: "{{ appname_service_become_flags }}"
  when: appname_service_script is not defined
  block:
    - name: "Include service module action tasks - {{ appname_service_action }}"
      ansible.builtin.include_tasks: "{{ appname_service_action }}_service.yml"
