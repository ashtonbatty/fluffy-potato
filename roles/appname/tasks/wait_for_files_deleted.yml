---
# Wait for files to be deleted from a directory and report remaining files via email
- name: "Check if file monitoring is enabled"
  ansible.builtin.debug:
    msg: "Monitoring {{ appname_file_monitor_path }} for file deletion"
  when: appname_file_monitor_enabled | default(false)

- name: "Wait for files to be deleted from {{ appname_file_monitor_path }}"
  when: appname_file_monitor_enabled | default(false)
  block:
    - name: "Monitor directory for file deletion with timeout"
      ansible.builtin.find:
        paths: "{{ appname_file_monitor_path }}"
        patterns: "{{ appname_file_monitor_patterns }}"
        recurse: false
      register: appname_monitor_result
      until: appname_monitor_result.files | length == 0
      retries: "{{ (appname_file_monitor_timeout / appname_file_monitor_check_interval) | int }}"
      delay: "{{ appname_file_monitor_check_interval }}"
      failed_when: false
      changed_when: false

    - name: "Gather remaining file information if timeout occurred"
      when: appname_monitor_result.files | length > 0
      block:
        - name: "Record remaining files event for reporting"
          ansible.builtin.set_fact:
            appname_file_monitor_events: "{{ appname_file_monitor_events | default([]) + [file_event] }}"
          vars:
            file_event:
              hostname: "{{ inventory_hostname }}"
              directory: "{{ appname_file_monitor_path }}"
              timeout: "{{ appname_file_monitor_timeout }}"
              remaining_files: "{{ appname_monitor_result.files }}"

        - name: "Display file monitoring status"
          ansible.builtin.debug:
            msg: "{{ appname_monitor_result.files | length }} files still present in {{ appname_file_monitor_path }} after timeout"

        - name: "Fail if configured to fail on timeout"
          ansible.builtin.fail:
            msg: "File deletion timeout: {{ appname_monitor_result.files | length }} files still present in {{ appname_file_monitor_path }}"
          when: appname_file_monitor_fail_on_timeout | default(true)

    - name: "All files successfully deleted"
      ansible.builtin.debug:
        msg: "All monitored files have been deleted from {{ appname_file_monitor_path }}"
      when: appname_monitor_result.files | length == 0
