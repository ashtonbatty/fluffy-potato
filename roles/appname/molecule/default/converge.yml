---
# Default Scenario: Happy-Path Testing
#
# This scenario tests basic, successful operations for both script-based
# and systemd service management. It verifies that the core functionality
# works correctly under normal conditions.
#
# For edge cases and failure scenarios, see the dedicated test scenarios:
#   - force-kill: Force-kill fallback when graceful shutdown fails
#   - file-monitoring: Age-based queue monitoring with timeouts
#   - return-codes: Custom return code validation
#   - idempotency: Start/stop idempotency checks
#   - privilege-escalation: Become configuration testing
#   - retry-logic: Retry exhaustion and eventual success
#   - workflow-reporting: Email notifications with mock SMTP

- name: Converge
  hosts: all
  become: true
  gather_facts: true

  pre_tasks:
    - name: Install required packages
      ansible.builtin.package:
        name:
          - python3
          - systemd
        state: present

    - name: Create test script directory
      ansible.builtin.file:
        path: /scripts
        state: directory
        mode: '0755'

    - name: Create test service script
      ansible.builtin.copy:
        dest: /scripts/testservice.sh
        mode: '0755'
        content: |
          #!/bin/bash
          case "$1" in
            start)
              echo "starting testservice"
              exit 0
              ;;
            stop)
              echo "stopping testservice"
              exit 0
              ;;
            status)
              echo "testservice is running"
              exit 0
              ;;
            *)
              echo "Usage: $0 {start|stop|status}"
              exit 1
              ;;
          esac

    - name: Create test systemd service
      ansible.builtin.copy:
        dest: /etc/systemd/system/systemd-test.service
        mode: '0644'
        content: |
          [Unit]
          Description=Test Service for Molecule

          [Service]
          Type=simple
          ExecStart=/bin/sleep infinity

          [Install]
          WantedBy=multi-user.target

    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: true

  tasks:
    # ========================================
    # Happy-Path Test Cases
    # ========================================

    # Test 1: Script-based service - status check
    # Verifies basic script execution with output validation
    - name: Test script-based service - status
      ansible.builtin.include_role:
        name: appname
      vars:
        appname_service_name: "testservice"
        appname_service_script: "/scripts/testservice.sh"
        appname_service_action: "status"
        appname_email_enabled: false

    # Test 2: Systemd service - full lifecycle (start → status → stop)
    # Verifies systemd integration and state transitions
    - name: Test systemd service - start
      ansible.builtin.include_role:
        name: appname
      vars:
        appname_service_name: "systemd-test"
        appname_service_action: "start"
        appname_email_enabled: false

    - name: Test systemd service - status
      ansible.builtin.include_role:
        name: appname
      vars:
        appname_service_name: "systemd-test"
        appname_service_action: "status"
        appname_email_enabled: false

    - name: Test systemd service - stop
      ansible.builtin.include_role:
        name: appname
      vars:
        appname_service_name: "systemd-test"
        appname_service_action: "stop"
        appname_email_enabled: false
